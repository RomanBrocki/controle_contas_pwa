<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Contas ‚Äî Mock PWA</title>

  <!-- Tailwind (utilit√°rios como flex/grid/gap/...) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel para transformar JSX no navegador (apenas para prot√≥tipo) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Evita flash branco ao carregar */
    html, body, #root { height: 100%; margin:0; }
  </style>
</head>
<body>
  <div id="root"></div>
    
  <script type="text/babel">
    // ====== APP (mesmo mock do canvas) ======
    function App() {
      return (
        <div className="min-h-screen">
          <StyleTag />
          <PostLoginMock />
        </div>
      );
    }

    function StyleTag() {
      return (
        <style>{`
:root {
  --radius: 16px;

}

/* ==== THEMES ==== */
.theme-gunmetal {
  --bg: #0e1218; --surface: #141923; --text: #e5e7eb; --muted: #93a1b1;
  --primary: #22d3ee; --primary-600: #06b6d4; --accent: #ff38a1; --danger: #ef4444;
  --border: #232a36; --chip: #1a2130; --glow: 0 0 24px rgba(34,211,238,.25), 0 0 4px rgba(34,211,238,.4);
}
.theme-synth {
  --bg: #0a1114; --surface: #101a1f; --text: #e6fffb; --muted: #8abcb6;
  --primary: #2dd4bf; --primary-600: #14b8a6; --accent: #f472b6; --danger: #ef4444;
  --border: #1b2a2f; --chip: #0f1a1e; --glow: 0 0 18px rgba(45,212,191,.22);
}
/* Light met√°lico ‚Äî foco em contraste e superf√≠cies prateadas */
.theme-light {
  --bg: #edf1f5; /* steel 50 */
  --surface: #ffffff; /* metal plate */
  --text: #0b1220;
  --muted: #475569;
  --primary: #3b82f6;
  --primary-600: #2563eb;
  --accent: #22c55e;
  --danger: #dc2626;
  --border: #d7e0ea; /* hairline cool gray */
  --chip: #f5f7fa; /* light chip */
  --glow: 0 0 16px rgba(59,130,246,.20);
}
:root {
  /* Paleta neutra para PDFs */
  --chart-bg-pdf: #ffffff;
  --chart-text-pdf: #1f2937;    /* cinza-escuro */
  --chart-line-pdf: #4b5563;    /* cinza m√©dio */
  --chart-colors-pdf: #3b82f6, #10b981, #f59e0b, #ef4444, #8b5cf6, #06b6d4, #84cc16, #ec4899;
}

/* ==== BASE ==== */
* { box-sizing: border-box; }
body, #root { background: var(--bg); color: var(--text); }
.card { background: var(--surface); border:1px solid var(--border); border-radius: var(--radius); padding:16px; transition: transform .15s ease, box-shadow .2s ease; }
.btn { border-radius: 9999px; padding: 8px 14px; font-weight:600; }
.btn.primary { background: var(--primary); color:#0a0a0a; box-shadow: var(--glow); }
.btn.ghost { background:transparent; border:1px solid var(--border); color:var(--text); }
.btn.danger { background:var(--danger); color:#0a0a0a; }
.badge { background:var(--chip); color:var(--muted); border-radius:9999px; padding:4px 8px; font-size:12px; }
.overlay {
  position: fixed;
  inset: 0;
  background: #000 !important;     /* opaco de verdade */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2147483647 !important;   /* garante que fica acima de tudo */
}

/* Base opaca (sem vidro) */
.modal {
  background: var(--surface);
  border-radius: 20px;
  border: 1px solid var(--border);
  padding: 24px;
  animation: pop-in .18s ease;
}
/* Vidro (use .modal.glass onde quiser translucidez) */
.modal.glass {
  background: rgba(20,25,35,.9);
  backdrop-filter: blur(8px);
}
.theme-light .modal.glass {
  background: rgba(255,255,255,.95);
}

/* Opaco expl√≠cito (use .modal.solid para for√ßar) */
.modal.solid {
  background: var(--surface) !important;
  color: var(--text) !important;
  backdrop-filter: none !important;
  opacity: 1 !important;
}

input.input, select.select { background: #0c0f14; color: var(--text); border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
/* Ajustes de campo no tema claro para contraste adequado */
.theme-light input.input, .theme-light select.select { background: #ffffff; color: #0b1220; border-color: #d7e0ea; }
.theme-light .modal { background: #fff !important; color:#0b1220; }

/* Brand */
.brand { font-size: 2.125rem; font-weight: 800; letter-spacing:.5px; background: linear-gradient(90deg, var(--primary), var(--accent)); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 0 0 24px rgba(34,211,238,.25); }

/* Animations */
@keyframes pop-in { from { opacity:0; transform: scale(.98); } to { opacity:1; transform: scale(1); } }
.pop { animation: pop-in .18s ease; }
.pulse { box-shadow: 0 0 0 0 rgba(34,211,238,.35); animation: pulse 600ms ease-out; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34,211,238,.45); transform: scale(1.01);} 100% { box-shadow: 0 0 0 12px rgba(34,211,238,0); transform: scale(1);} }

/* ==== RESPONSIVO & AJUSTES M√ìVEIS ==== */

/* garante que o ‚Äúfundo de fora‚Äù siga o tema (corrige o Claro Met√°lico) */
html { background: var(--bg); }

/* mobile-first: modal full-screen no celular */
@media (max-width: 767.98px) {
  .modal {
    width: 100vw;
    height: 100vh;
    max-width: none;      /* ignora max-w-lg em telas pequenas */
    border-radius: 0;
    padding: 16px;
    overflow: auto;
  }
  .brand { font-size: clamp(1.5rem, 6vw, 2rem); }
}

/* telas m√©dias+ : modal confort√°vel e rol√°vel se precisar */
@media (min-width: 768px) {
  .modal { max-height: 90vh; overflow: auto; }
}

/* toques mais confort√°veis em qualquer tela */
.btn { min-height: 40px; }
.input, .select { min-height: 40px; }

/* Centraliza o grid principal e limita largura */
main.grid { max-width: 72rem; margin-inline: auto; }

/* Evita t√≠tulo ‚Äúespremido‚Äù no modal e melhora respiro */
.modal h2 { margin: 0 0 12px; line-height: 1.2; }

/* Garante que o conte√∫do do modal role e o rodap√© fique vis√≠vel */
.modal { display: flex; flex-direction: column; }
.modal .content { flex: 1 1 auto; overflow: auto; }
.modal .footer { margin-top: 12px; }

/* Bot√µes de a√ß√£o sempre ‚Äútoc√°veis‚Äù */
.modal .footer .btn { min-height: 40px; }

/* Extra: espa√ßo no fundo para n√£o ‚Äúsumir‚Äù bot√£o em telas pequenas */
@media (max-width: 767.98px) {
  .modal { padding-bottom: 16px; }
}

/* ===== Sub-bloco de sele√ß√£o de m√™s/ano (reutiliz√°vel) ===== */
.subpick {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
  background: color-mix(in srgb, var(--surface) 92%, transparent);
  margin-top: 6px;
}
.subpick h3 {
  text-align: center;
  font-weight: 600;
  margin: 0 0 10px 0;
  letter-spacing: .2px;
}
.subpick .row {
  display: grid;
  grid-template-columns: 1fr 1fr; /* ano | m√™s lado a lado tamb√©m no mobile */
  gap: 8px;
}
.subpick .cell { display: flex; align-items: center; gap: 6px; }
.subpick label { font-size: .9rem; opacity: .75; white-space: nowrap; }

/* === Modal "Contas Pendentes" totalmente opaco === */
.modal.solid {
  background-color: var(--surface) !important;
  color: var(--text) !important;
  opacity: 1 !important;
  backdrop-filter: none !important;
  box-shadow: 0 0 24px rgba(0,0,0,0.4); /* leve destaque para n√£o "fundir" com o fundo */
}

/* Tema claro: fundo branco real, sem alpha */
body.theme-light .modal.solid {
  background-color: #ffffff !important;
}

/* Tema synth: leve brilho ciano */
body.theme-synth .modal.solid {
  background-color: #101a1f !important;
  box-shadow: 0 0 24px rgba(45,212,191,.25);
}

/* Tema gunmetal: fundo uniforme, mais contraste */
body.theme-gunmetal .modal.solid {
  background-color: #141923 !important;
}

/* Overlay mais escura/sem transpar√™ncia vis√≠vel para o lembrete */
.overlay.hard { background: rgba(0,0,0,0.88) !important; }

/* Chips de contas: texto quebra em m√∫ltiplas linhas sem colar no checkbox */
.account-chip { padding: 10px 12px; }
.account-chip__text {
  display: inline-block;
  line-height: 1.25;
  word-break: break-word;
  overflow-wrap: anywhere;
}



`}</style>
      );
    }

    function parseBRL(str){
      const s = String(str).replace(/[^\d,]/g, '').replace(/\.(?=\d)/g,'');
      return Number(s.replace(',', '.')) || 0;
    }

    function monthNamePT(m){
      return new Date(2025, m-1, 1).toLocaleString('pt-BR', { month:'long' }).replace(/^./, c=>c.toUpperCase());
    }

    function todayISO(){
      const d = new Date();
      return d.toISOString().slice(0,10); // yyyy-mm-dd
    }

    function parseBRtoISO(ddmmyyyy){
      const m = String(ddmmyyyy||'').match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if (!m) return '';
      const [,dd,mm,yyyy] = m;
      return `${yyyy}-${mm}-${dd}`;
    }

    function CanvasPlaceholder({ aspect='16/9' }){
      return (
        <div className="w-full" style={{aspectRatio: aspect}}>
          <div className="w-full h-full" style={{
            borderRadius: 12,
            border: '1px dashed var(--border)',
            background: 'repeating-linear-gradient(45deg, rgba(255,255,255,.06) 0 8px, rgba(255,255,255,.02) 8px 16px)'
          }}/>
        </div>
      );
    }
    // Top 10 tipos de conta (mock)
    const COMMON_TYPES = ['Energia','Internet','√Ågua','Condom√≠nio','Escola','Celular','Transporte','Mercado','Streaming','IPTU'];

    function PostLoginMock() {
      const [theme, setTheme] = React.useState('gunmetal');
      const [showOverlay, setShowOverlay] = React.useState(true);
      const [editing, setEditing] = React.useState(null); // {mode:'edit'|'new', item:{...}}
      const [activeId, setActiveId] = React.useState(null); // anima o card clicado
      const [showReports, setShowReports] = React.useState(false);
      const [reportsTab, setReportsTab] = React.useState('home'); // 'mensal' | 'periodo' | 'comparativos'

      // üîπ Anos e meses reais do Supabase
      const [years, setYears] = React.useState([]);
      const [monthsByYear, setMonthsByYear] = React.useState({});

      // Carrega anos e meses dispon√≠veis do banco
      React.useEffect(() => {
        (async () => {
          try {
            const yrs = await window.SupabaseQueries.listYears();
            setYears(yrs);

            const monthsMap = {};
            for (const y of yrs) {
              const months = await window.SupabaseQueries.listMonthsByYear(y);
              monthsMap[y] = months;
            }
            setMonthsByYear(monthsMap);
          } catch (err) {
            console.error('[ui] Erro ao carregar anos/meses', err);
          }
        })();
      }, []);
      
      // Se o ano padr√£o (2025) n√£o existir no banco, pega o mais recente dispon√≠vel
      React.useEffect(() => {
        if (years.length && !years.includes(yearSel)) {
          setYearSel(years[0]); // assumindo que listYears() j√° retorna DESC
        }
      }, [years]);


      const [yearSel, setYearSel] = React.useState(2025);
      const [monthSel, setMonthSel] = React.useState(10); // outubro atual

      // ---- Pend√™ncias (din√¢mico): estados + helpers ----
      const [pendentes, setPendentes] = React.useState(null); // null = calculando
      const [pendLoading, setPendLoading] = React.useState(false);
      // normaliza: remove acentos, trim e baixa caixa
      function normalize(str='') {
        return String(str)
          .normalize('NFD')                // decomp√µe acentos
          .replace(/[\u0300-\u036f]/g, '') // remove diacr√≠ticos
          .toLowerCase()
          .trim();
      }


      function prevYearMonth(y, m) {
        return m > 1 ? { y, m: m - 1 } : { y: y - 1, m: 12 };
      }
      function keyFor(i) {
        return `${normalize(i.nome)}__${normalize(i.instancia)}`;
      }



      // Exponho handlers para o Router (sem depender de React fora do componente)
      React.useEffect(() => {
        window.AppRoutes = {
          mes: ({ ano, mes } = {}) => {
            if (ano) setYearSel(Number(ano));
            if (mes) setMonthSel(Number(mes));
          },
          relatorios: () => {
            setReportsTab('home');
            setShowReports(true);
          }
        };
        return () => { if (window.AppRoutes) delete window.AppRoutes; };
      }, []);


      React.useEffect(()=>{
        const avail = monthsByYear[yearSel] || [];
        if (!avail.includes(monthSel)) {
          setMonthSel(avail[0] || monthSel); // mais recente do ano
        }
      }, [yearSel]);

      // ---- Calcula pend√™ncias comparando m√™s atual x anterior ----
      React.useEffect(() => {
        let alive = true;
        (async () => {
          try {
            setPendLoading(true);
            const { y, m } = prevYearMonth(yearSel, monthSel);
            const [cur, prev] = await Promise.all([
              window.DataAdapter.fetchMes(yearSel, monthSel),
              window.DataAdapter.fetchMes(y, m)
            ]);

            const curKeys = new Set((cur || []).map(keyFor));
            const listaPend = (prev || []).filter(p => !curKeys.has(keyFor(p)));

            if (!alive) return;
            setPendentes(listaPend);
            // se houver pend√™ncia, mostra overlay; se n√£o, esconde
            setShowOverlay(listaPend.length > 0);
          } catch (e) {
            console.error('[pendentes] erro ao calcular', e);
            if (!alive) return;
            setPendentes([]);
            setShowOverlay(false);
          } finally {
            if (alive) setPendLoading(false);
          }
        })();
        return () => { alive = false; };
      }, [yearSel, monthSel]);

      // Itens reais do m√™s (Supabase) + loading
      const [itens, setItens] = React.useState(null); // null = carregando

      React.useEffect(() => {
        let alive = true;
        (async () => {
          try {
            const mapped = await window.DataAdapter.fetchMes(yearSel, monthSel);
            if (alive) setItens(mapped);
          } catch (err) {
            console.error('[ui] Falha ao carregar m√™s', err);
            if (alive) setItens([]);
          }
        })();
        return () => { alive = false; };
      }, [yearSel, monthSel]);

      // Toast simples
      const [toast, setToast] = React.useState(null); // { msg, type: 'ok'|'err' }
      function showToast(msg, type='ok'){
        setToast({ msg, type });
        setTimeout(() => setToast(null), 1800);
      }

      // Recarrega s√≥ a lista do m√™s atual
      async function reloadMonth(){
        const mapped = await window.DataAdapter.fetchMes(yearSel, monthSel);
        setItens(mapped);
      }

      // Pequena valida√ß√£o/sanitiza√ß√£o de URL (http/https)
      function cleanUrl(u){
        if(!u) return '';
        const s = String(u).trim();
        if(/^https?:\/\//i.test(s)) return s;
        return 'https://' + s;
      }

      async function handleSave(mode, initialId, form){
        try{
          // resolve 'quem'
          const quem = form.quemMode === 'outro' ? (form.quemOutro || '').trim() : (form.quem || '').trim();

          // montar draft para a tabela existente
          const d = new Date(form.data || todayISO());
          const ano = d.getFullYear();
          const mes = d.getMonth() + 1;

          const draft = {
            nome_da_conta: (form.nome || '').trim(),
            valor: parseBRL(form.valor),
            data_de_pagamento: form.data || todayISO(),
            instancia: (form.instancia || '').trim(),
            quem_pagou: quem,
            dividida: !!form.dividida,
            link_boleto: cleanUrl(form.boleto),
            link_comprovante: cleanUrl(form.comp),
            ano, mes
          };

          let ok = false;
          if (mode === 'new') {
            ok = await window.SupabaseMutations.insertConta(draft);
          } else {
            ok = await window.SupabaseMutations.updateConta(initialId, draft);
          }
          if(!ok) throw new Error('Falha no Supabase');

          await reloadMonth();
          showToast('Conta salva ‚úÖ','ok');
          setEditing(null);
        } catch(e){
          console.error('[save] erro', e);
          showToast('Erro ao salvar ‚ùå','err');
        }
      }

      async function handleDelete(id){
        try{
          const ok = await window.SupabaseMutations.deleteConta(id);
          if(!ok) throw new Error('Falha no Supabase');
          await reloadMonth();
          showToast('Conta exclu√≠da üóëÔ∏è','ok');
          setEditing(null);
        } catch(e){
          console.error('[delete] erro', e);
          showToast('Erro ao excluir ‚ùå','err');
        }
      }


      const [payersDB, setPayersDB] = React.useState([]);

      React.useEffect(() => {
        (async () => {
          try {
            const list = await window.SupabaseQueries.payersDistinct();
            setPayersDB(list || []);
          } catch (e) {
            console.error('[ui] payersDistinct', e);
            setPayersDB([]);
          }
        })();
      }, []);


      const totalMes = React.useMemo(
        () => (itens ? itens.reduce((acc,i)=> acc + parseBRL(i.valor), 0) : 0),
        [itens]
      );
      const contasDistinct = React.useMemo(
        () => Array.from(new Set((itens || []).map(i=> i.nome))),
        [itens]
      );


      function popCard(id){
        setActiveId(id);
        setTimeout(()=> setActiveId(null), 650);
      }

      function openNew(prefill){
        popCard('new');
        setEditing({
          mode:'new',
          item: {
            id:null,
            nome: prefill?.nome || '',
            valor:'',
            data: todayISO(),
            instancia: prefill?.instancia || '',
            quem: prefill?.quem || '',
            dividida: !!prefill?.dividida,
            links: { boleto:'', comp:'' }
          }
        });
      }

      function openEdit(item){
        popCard(item.id);
        const isoDate = parseBRtoISO(item.data) || todayISO();
        setEditing({ mode:'edit', item: { ...JSON.parse(JSON.stringify(item)), data: isoDate } });
      }

      return (
        <div className={`theme-${theme} min-h-screen relative p-4 md:p-6`}>
          <div className="mx-auto w-full max-w-5xl">
          {/* Header */}
          <header className="flex flex-col gap-3 md:flex-row md:justify-between md:items-center mb-6">
            <h1 className="brand text-center md:text-left w-full">üí∏ Controle de Contas</h1>
            <div className="flex flex-col gap-2 w-full sm:grid sm:grid-cols-2 md:flex md:flex-row md:items-center">
              <button className={`btn primary w-full md:w-auto ${activeId==='new' ? 'pop' : ''}`} onClick={()=>openNew()}>+ Nova Conta</button>
              <button className="btn ghost w-full md:w-auto" onClick={()=>{ setReportsTab('home'); setShowReports(true); }}>üìä Relat√≥rios</button>
              <select className="btn ghost w-full md:w-auto" value={theme} onChange={e=>setTheme(e.target.value)}>
                <option value="gunmetal">Gunmetal Neon</option>
                <option value="synth">Synthwave Teal</option>
                <option value="light">Claro Met√°lico</option>
              </select>
            </div>
          </header>
        

          {/* Overlay p√≥s-login (din√¢mico) */}
          {showOverlay && (
            <div className="overlay hard" onClick={() => setShowOverlay(false)}>
              <div className="modal solid max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                <h2 className="text-lg font-semibold mb-3">üí∞ Contas Pendentes</h2>

                {pendentes === null || pendLoading ? (
                  <div className="card text-center py-6">Calculando‚Ä¶</div>
                ) : pendentes.length === 0 ? (
                  <div className="card text-center py-6 text-sm opacity-70">
                    Nenhuma conta do m√™s anterior est√° pendente.
                  </div>
                ) : (
                  <ul className="space-y-2 mb-4">
                    {pendentes.slice(0, 6).map((p, idx) => (
                      <li key={`${keyFor(p)}-${idx}`} className="card flex justify-between items-center">
                        <div>
                          <strong>{p.nome}</strong><br />
                          {/* Mostramos os dados do m√™s anterior s√≥ como contexto visual */}
                          <span className="text-sm opacity-70">
                            {p.instancia ? `${p.instancia} ‚Ä¢ ` : ''}{p.valor} ‚Ä¢ {p.data}
                          </span>
                        </div>
                        <button
                          className="btn primary"
                          onClick={() => {
                            // abre modal "Nova Conta" pr√©-preenchido (valor e data continuam padr√£o: vazio/hoje)
                            setShowOverlay(false);
                            openNew({ nome: p.nome, instancia: p.instancia, quem: p.quem, dividida: p.dividida });
                          }}
                        >
                          Lan√ßar agora
                        </button>
                      </li>
                    ))}
                  </ul>
                )}

                <button className="btn ghost w-full" onClick={() => setShowOverlay(false)}>Sair</button>
              </div>
            </div>
          )}


          {/* Resumo do m√™s + seletor ano/m√™s (meses DESC e nomes apenas) */}
          <section className="card mb-6 flex flex-wrap items-center gap-4">
            <div>
              <div className="text-sm opacity-70">Total do m√™s</div>
              <div className="text-2xl font-semibold" style={{textShadow:'var(--glow)'}}>
                {totalMes.toLocaleString('pt-BR', { style:'currency', currency:'BRL' })}
              </div>
            </div>
            <div className="ml-auto flex items-center gap-2">
              <label className="text-sm opacity-70">Ano</label>
              <select
                className="select"
                value={yearSel}
                onChange={e=>{
                  const y = Number(e.target.value);
                  setYearSel(y);
                  Router.go(`#/mes?ano=${y}&mes=${monthSel}`);
                }}
              >
                {years.map(y=> <option key={y} value={y}>{y}</option>)}
              </select>
              <label className="text-sm opacity-70">M√™s</label>
              <select
                className="select"
                value={monthSel}
                onChange={e=>{
                  const m = Number(e.target.value);
                  setMonthSel(m);
                  Router.go(`#/mes?ano=${yearSel}&mes=${m}`);
                }}
              >
                {(monthsByYear[yearSel]||[]).map(m=> (
                  <option key={m} value={m}>{monthNamePT(m)}</option>
                ))}
              </select>
            </div>
          </section>

          {/* ================================================ */}
          {/* üì≠ Lista de contas do m√™s (loading / vazio / itens) */}
          {itens === null ? (
            <div className="card text-center py-10">Carregando‚Ä¶</div>
          ) : itens.length === 0 ? (
            <div className="card text-center py-10">
              <h3 className="text-lg font-semibold mb-2">Nenhuma conta neste m√™s</h3>
              <p className="text-sm opacity-70 mb-4">Voc√™ ainda n√£o adicionou nenhuma conta para este per√≠odo.</p>
              <button className="btn primary" onClick={() => openNew()}>+ Adicionar primeira conta</button>
            </div>
          ) : (
            <main className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
              {itens.map((i) => (
                <ContaCard key={i.id} active={activeId === i.id} {...i} onEdit={() => openEdit(i)} />
              ))}
            </main>
          )}



          {editing && (
            <EditPopup
              data={editing}
              payers={payersDB}
              onClose={()=>setEditing(null)}
              onSave={handleSave}
              onDelete={handleDelete}
            />
          )}


          {showReports && (
            <ReportsModal
              tab={reportsTab}
              onChangeTab={setReportsTab}
              onClose={()=>setShowReports(false)}
              years={years}
              monthsByYear={monthsByYear}
              currentYear={yearSel}
              currentMonth={monthSel}
              contasDistinct={Array.from(new Set((itens || []).map(i=> i.nome)))}
            />
          )}
          {toast && (
            <div className="fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg border"
                style={{ background:'var(--surface)', borderColor:'var(--border)', boxShadow:'var(--glow)' }}>
              <span className="text-sm">{toast.msg}</span>
            </div>
          )}

          </div>{/* /max-w wrapper */}
        </div>
      );
    }

    function ContaCard({ nome, instancia, valor, data, quem, dividida, links, onEdit, active }) {
      return (
        <article className={`card space-y-2 ${active ? 'pulse' : ''}`}>
          <div className="flex justify-between items-start">
            <div>
              <h3 className="text-lg font-semibold">{nome}</h3>
              <div className="text-sm opacity-70">{instancia}</div>
            </div>
            <div className="text-right">
              <div className="text-lg font-semibold" style={{textShadow:'var(--glow)'}}>{valor}</div>
              <div className="text-xs opacity-70">{data}</div>
            </div>
          </div>
          <div className="flex flex-wrap gap-2 items-center">
            {/* Linha 1: badges sempre √† esquerda */}
            <span className="badge">{dividida ? 'Dividida' : 'N√£o dividida'}</span>
            <span className="badge">{quem}</span>

            {/* Linha 2: links √† esquerda, bot√£o Editar fixo √† direita */}
            <div className="w-full flex flex-wrap items-center justify-between gap-2 mt-1">
              <div className="flex gap-2 flex-wrap">
                {links?.boleto && (
                  <a className="btn ghost" href={links.boleto} target="_blank" rel="noreferrer">Boleto</a>
                )}
                {links?.comp && (
                  <a className="btn ghost" href={links.comp} target="_blank" rel="noreferrer">Comprovante</a>
                )}
              </div>
              <button className="btn ghost ml-auto" onClick={onEdit}>Editar</button>
            </div>
          </div>


        </article>
      );
    }

    function EditPopup({ data, payers, onClose, onSave, onDelete }) {
      const { mode, item: initial } = data;
      // Fecha o modal ao pressionar Esc (desktop apenas)
      React.useEffect(() => {
        const handleKey = (e) => {
          if (e.key === 'Escape') onClose();
        };
        window.addEventListener('keydown', handleKey);
        return () => window.removeEventListener('keydown', handleKey);
      }, []);
      const [form, setForm] = React.useState(()=>({
        nome: initial.nome || '',
        valor: initial.valor || '',
        data: initial.data || todayISO(),
        instancia: initial.instancia || '',
        quem: initial.quem || '',
        quemOutro: '',
        quemMode: initial.quem && payers.includes(initial.quem) ? 'select' : (initial.quem ? 'outro' : 'select'),
        dividida: !!initial.dividida,
        boleto: initial.links?.boleto || '',
        comp: initial.links?.comp || ''
      }));

      const pristine = React.useMemo(()=>{
        const canonicalQuem = form.quemMode==='outro' ? form.quemOutro : form.quem;
        const a = JSON.stringify({
          nome: initial.nome||'', valor: initial.valor||'', data: initial.data || todayISO(),
          instancia: initial.instancia||'', quem: initial.quem||'', dividida: !!initial.dividida,
          boleto: initial.links?.boleto||'', comp: initial.links?.comp||''
        });
        const b = JSON.stringify({
          nome: form.nome||'', valor: form.valor||'', data: form.data||'',
          instancia: form.instancia||'', quem: canonicalQuem||'', dividida: !!form.dividida,
          boleto: form.boleto||'', comp: form.comp||''
        });
        return a===b;
      }, [form, initial]);
      

      const isQuemValid = form.quemMode==='select' ? !!form.quem : !!form.quemOutro.trim();
      const isNomeValid = !!form.nome.trim();
      const isValorValid = !!form.valor.trim();
      const isFormValid = isQuemValid && isNomeValid && isValorValid;

      function upd(k,v){ setForm(f=>({...f,[k]:v})); }
      const setQuemMode = (mode)=> upd('quemMode', mode);

      function onSubmit(){
        if(!isFormValid) return;
        onSave(mode, initial.id, form); // parent resolve insert/update, fecha e toast
      }
      function onDeleteClick(){
        if(mode!=='edit') return;
        onDelete(initial.id); // parent resolve exclus√£o
      }


      return (
        <div className="overlay" onClick={onClose}>
          <div className="modal max-w-lg w-full pop" role="dialog" aria-modal="true" aria-labelledby="edit-title" onClick={e=>e.stopPropagation()}>
            <h3 id="edit-title" className="text-lg font-semibold mb-3">{mode==='new' ? 'Nova Conta' : 'Editar Conta'}</h3>
            <form className="space-y-3" onSubmit={e=>e.preventDefault()} onKeyDown={(e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey) && isFormValid){ onSubmit(); } }}>
              {/* Tipo de conta: Top10 + ‚ÄúOutro‚Ä¶‚Äù */}
              <div>
                <label className="text-sm opacity-80">Tipo de conta</label>

                {/* SELECT sempre aparece primeiro; input s√≥ aparece se escolher ‚ÄúOutro‚Ä¶‚Äù */}
                <select
                  className="w-full select"
                  value={form.nome || ''}
                  onChange={e=>{
                    const v = e.target.value;
                    if (v === '__outro') {
                      // n√£o escrever ‚Äúde cara‚Äù: zera o nome e mostra o input
                      upd('nome','');
                      // marca um flag leve s√≥ para renderizar o input abaixo
                      // (sem criar campo novo no form, para manter o resto intacto)
                      e.target.dataset._outro = '1';
                      const host = e.target.closest('div');
                      const input = host?.querySelector('[data-nome-outro]');
                      if (input) input.style.display = '';
                    } else {
                      // escolheu uma op√ß√£o do Top10 (ou a op√ß√£o ‚Äú(atual)‚Äù)
                      upd('nome', v);
                      // esconde o input ‚ÄúOutro‚Äù
                      const host = e.target.closest('div');
                      const input = host?.querySelector('[data-nome-outro]');
                      if (input) input.style.display = 'none';
                    }
                  }}
                >
                  <option value="">Selecione‚Ä¶</option>

                  {/* Se estiver editando e o nome atual N√ÉO estiver no Top10, mostra op√ß√£o ‚Äú(atual)‚Äù */}
                  {(initial.nome && !COMMON_TYPES.includes(initial.nome)) ? (
                    <option value={initial.nome}>{initial.nome} (atual)</option>
                  ) : null}

                  {COMMON_TYPES.map(n => (
                    <option key={n} value={n}>{n}</option>
                  ))}
                  <option value="__outro">Outro‚Ä¶</option>
                </select>

                {/* Mostra aviso se tipo de conta estiver vazio */}
                {!form.nome.trim() && (
                  <div className="text-xs text-red-400 mt-1">Campo obrigat√≥rio</div>
                )}


                {/* Input ‚ÄúOutro‚Ä¶‚Äù (inicialmente oculto) */}
                <div data-nome-outro style={{display: 'none', marginTop: '8px'}}>
                  <input
                    className="w-full input"
                    placeholder="Digite o tipo de conta"
                    value={form.nome}
                    onChange={e=>upd('nome', e.target.value)}
                  />
                  <div className="text-xs opacity-70 mt-1">Campo obrigat√≥rio</div>
                  <button
                    type="button"
                    className="btn ghost mt-2"
                    onClick={(e)=>{
                      // volta ao seletor e esconde o input
                      upd('nome','');
                      const host = e.currentTarget.closest('div[data-nome-outro]');
                      if (host) host.style.display = 'none';
                    }}
                  >
                    Voltar ao seletor
                  </button>
                </div>
              </div>

              {/* ========================== */}
              {/* üí° Campo: Valor (obrigat√≥rio com hint visual) */}
              {/* ========================== */}
              <div>
                <label className="text-sm opacity-80">Valor</label>
                <input
                  className={`w-full input ${!form.valor.trim() ? 'border-red-500' : ''}`}
                  placeholder="R$ 0,00"
                  value={form.valor}
                  onChange={e=>upd('valor', e.target.value)}
                />
                {/* Mostra o aviso ‚ÄúCampo obrigat√≥rio‚Äù apenas se estiver vazio */}
                {!form.valor.trim() && (
                  <div className="text-xs text-red-400 mt-1">Campo obrigat√≥rio</div>
                )}
              </div>

              <div>
                <label className="text-sm opacity-80">Data de pagamento</label>
                <input type="date" className="w-full input" value={form.data} onChange={e=>upd('data', e.target.value)} />
              </div>

              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="text-sm opacity-80">Inst√¢ncia</label>
                  <input className="w-full input" placeholder="Residencial" value={form.instancia} onChange={e=>upd('instancia', e.target.value)} />
                </div>
                <div>
                  <label className="text-sm opacity-80">Quem pagou</label>
                  {form.quemMode==='select' ? (
                    <>
                      <select
                        className="w-full select"
                        value={form.quem}
                        onChange={e=>{
                          const v = e.target.value;
                          if (v === '__outro') {
                            upd('quem','');               // limpa o select
                            upd('quemOutro','');          // prepara campo livre
                            setQuemMode('outro');         // ativa modo 'outro'
                          } else {
                            upd('quem', v);
                            upd('quemOutro','');
                            setQuemMode('select');
                          }
                        }}
                      >
                        <option value="">Selecione‚Ä¶</option>
                        {payers.map(p=> <option key={p} value={p}>{p}</option>)}
                        <option value="__outro">Outro‚Ä¶</option>
                      </select>

                    </>
                  ) : (
                    <>
                      <input className="w-full input" placeholder="Digite o pagador" value={form.quemOutro} onChange={e=>upd('quemOutro', e.target.value)} />
                      <div className="text-xs opacity-70 mt-1">Campo obrigat√≥rio</div>
                      <button className="btn ghost mt-2" type="button" onClick={()=>{ upd('quem',''); upd('quemOutro',''); setQuemMode('select'); }}>Voltar ao seletor</button>
                    </>
                  )}
                  {/* Mostra aviso se ‚ÄúQuem pagou‚Äù estiver vazio */}
                  {!isQuemValid && (
                    <div className="text-xs text-red-400 mt-1">Campo obrigat√≥rio</div>
                  )}
                </div>
                                
              </div>

              <div className="flex items-center gap-2">
                <input id="dividida" type="checkbox" checked={form.dividida} onChange={e=>upd('dividida', e.target.checked)} />
                <label htmlFor="dividida">Dividida</label>
              </div>

              <div className="grid grid-cols-2 gap-2">
                <div>
                  <label className="text-sm opacity-80">Link boleto</label>
                  <input className="w-full input" placeholder="https://..." value={form.boleto} onChange={e=>upd('boleto', e.target.value)} />
                </div>
                <div>
                  <label className="text-sm opacity-80">Link comprovante</label>
                  <input className="w-full input" placeholder="https://..." value={form.comp} onChange={e=>upd('comp', e.target.value)} />
                </div>
              </div>

              <div className="flex flex-wrap gap-2 mt-2">
                {!pristine && isFormValid && (
                  <button className="btn primary" type="button" onClick={onSubmit}>Salvar</button>
                )}
                <button className="btn ghost" type="button" onClick={onClose}>Cancelar</button>
                {mode==='edit' && <button className="btn danger" type="button" onClick={onDeleteClick}>Excluir</button>}
              </div>

            </form>
          </div>
        </div>
      );
    }
    function MonthPickerBlock({
      title,
      year, setYear,
      month, setMonth,
      years,
      monthOptions,
      idPrefix
    }) {
      return (
        <div className="subpick">
          <h3>{title}</h3>
          <div className="row">
            <div className="cell">
              <label htmlFor={`${idPrefix}-ano`}>Ano</label>
              <select id={`${idPrefix}-ano`} className="select"
                      value={year} onChange={e=>setYear(Number(e.target.value))}>
                {years.map(y=> <option key={y} value={y}>{y}</option>)}
              </select>
            </div>
            <div className="cell" style={{justifyContent:'flex-end'}}>
              <label htmlFor={`${idPrefix}-mes`}>M√™s</label>
              <select id={`${idPrefix}-mes`} className="select"
                      value={month} onChange={e=>setMonth(Number(e.target.value))}>
                {monthOptions(year)}
              </select>
            </div>
          </div>
        </div>
      );
    }

    function ReportsModal({ tab, onChangeTab, onClose, years, monthsByYear, currentYear, currentMonth, contasDistinct }){
      // Fecha o modal ao pressionar Esc (desktop apenas)
      React.useEffect(() => {
        const handleKey = (e) => {
          if (e.key === 'Escape') onClose();
        };
        window.addEventListener('keydown', handleKey);
        return () => window.removeEventListener('keydown', handleKey);
      }, []);
      // Estados sincronizados com a tela principal ao abrir
      const [mensalYear, setMensalYear] = React.useState(currentYear);
      const [mensalMonth, setMensalMonth] = React.useState(currentMonth);

      const [pStartYear, setPStartYear] = React.useState(currentYear);
      const [pStartMonth, setPStartMonth] = React.useState(currentMonth);
      const [pEndYear, setPEndYear] = React.useState(currentYear);
      const [pEndMonth, setPEndMonth] = React.useState(currentMonth);

      const [cmpRange, setCmpRange] = React.useState('mes'); // 'mes' | 'periodo'
      const [cmpYear, setCmpYear] = React.useState(currentYear);
      const [cmpMonth, setCmpMonth] = React.useState(currentMonth);
      const [cmpStartYear, setCmpStartYear] = React.useState(currentYear);
      const [cmpStartMonth, setCmpStartMonth] = React.useState(currentMonth);
      const [cmpEndYear, setCmpEndYear] = React.useState(currentYear);
      const [cmpEndMonth, setCmpEndMonth] = React.useState(currentMonth);
      const [cmpType, setCmpType] = React.useState('linhas'); // 'linhas' | 'barras' | 'pizza'
      const [cmpSel, setCmpSel] = React.useState(()=> new Set()); // padr√£o: nenhum marcado


      // --- NOVOS ESTADOS ---
      const [cmpContas, setCmpContas] = React.useState([]); // lista din√¢mica p/ sele√ß√£o
      const [cmpWarnings, setCmpWarnings] = React.useState([]); // avisos de ‚Äúsem dados compar√°veis‚Äù etc.

      // --- HELPERS ---
      function makeMonthsList(y1,m1,y2,m2){
        const out=[]; let y=y1, m=m1;
        while (y<y2 || (y===y2 && m<=m2)) { out.push({y,m}); m++; if(m>12){m=1;y++;} }
        return out;
      }
      function parseBRLnum(brl){
        return parseFloat(String(brl||'').replace(/[^\d,]/g,'').replace(/\.(?=\d)/g,'').replace(',','.'))||0;
      }
      function sumByConta(items, contasSel){
        return contasSel.map(c => items.filter(x=>x.nome===c).reduce((a,b)=>a+parseBRLnum(b.valor),0));
      }
      async function contasDistinctRange(range){
        // Sempre derive da lista real do per√≠odo via DataAdapter.fetchMes
        if (range === 'mes') {
          const itens = await window.DataAdapter.fetchMes(cmpYear, cmpMonth);
          return Array.from(new Set((itens || []).map(i => i.nome)));
        }
        // per√≠odo ‚Üí uni√£o de todos os meses do intervalo
        const months = makeMonthsList(cmpStartYear, cmpStartMonth, cmpEndYear, cmpEndMonth);
        const respostas = await Promise.all(months.map(({y,m}) => window.DataAdapter.fetchMes(y,m)));
        const acc = new Set();
        respostas.forEach(items => (items || []).forEach(i => acc.add(i.nome)));
        return Array.from(acc);
      }


      // quando trocar alcance, limitar op√ß√µes de gr√°fico e ajustar valor padr√£o
      React.useEffect(()=>{
        if (cmpRange==='mes' && (cmpType==='linhas')) setCmpType('pizza');      // m√™s: pizza, barras
        if (cmpRange==='periodo' && (cmpType==='barras')) setCmpType('linhas');  // per√≠odo: pizza, linhas
      }, [cmpRange]);

      // recarrega a lista din√¢mica de contas ao mudar alcance ou datas
      React.useEffect(()=>{
        (async()=>{
          const lista = await contasDistinctRange(cmpRange);
          setCmpContas(lista);
          // mant√©m sele√ß√£o somente do que ainda existe
          setCmpSel(prev => new Set(Array.from(prev).filter(n=>lista.includes(n))));


        })();
      }, [cmpRange, cmpYear, cmpMonth, cmpStartYear, cmpStartMonth, cmpEndYear, cmpEndMonth]);


      React.useEffect(()=>{
        setMensalYear(currentYear);
        setMensalMonth(currentMonth);
        setPStartYear(currentYear);
        setPStartMonth(currentMonth);
        setPEndYear(currentYear);
        setPEndMonth(currentMonth);
        setCmpYear(currentYear);
        setCmpMonth(currentMonth);
        setCmpStartYear(currentYear);
        setCmpStartMonth(currentMonth);
        setCmpEndYear(currentYear);
        setCmpEndMonth(currentMonth);
      }, [currentYear, currentMonth]);

      function monthOptions(y){
        return (monthsByYear[y]||[]).map(m => <option key={m} value={m}>{monthNamePT(m)}</option>);
      }

      function toggleConta(name){
        setCmpSel(prev => {
          const n = new Set(prev);
          n.has(name) ? n.delete(name) : n.add(name);
          return n;
        });
      }

      return (
        <div className="overlay" onClick={onClose}>
          <div className={`modal glass ${tab==='home' ? 'max-w-md' : 'max-w-3xl'} w-full pop`} role="dialog" aria-modal="true" aria-labelledby="reports-title" onClick={e=>e.stopPropagation()}>


            {/* Header */}
            <div className="flex items-center gap-3 mb-3">
              <h3 id="reports-title" className="text-lg font-semibold">Relat√≥rios</h3>
              <div className="ml-auto flex gap-2">
                <button className="btn ghost" onClick={onClose}>Fechar</button>
              </div>
            </div>

            {/* Tela inicial com 3 op√ß√µes */}
            {tab==='home' && (
              <div className="grid gap-3">
                <button className="btn primary" onClick={()=>onChangeTab('mensal')}>Relat√≥rio mensal</button>
                <button className="btn primary" onClick={()=>onChangeTab('periodo')}>Relat√≥rio por per√≠odo</button>
                <button className="btn primary" onClick={()=>onChangeTab('comparativos')}>Gr√°ficos comparativos</button>
              </div>
            )}

            {/* MENSAL */}
            {tab==='mensal' && (
              <>
                <div className="content">
                  <MonthPickerBlock
                    title="Selecione o m√™s"
                    year={mensalYear} setYear={setMensalYear}
                    month={mensalMonth} setMonth={setMensalMonth}
                    years={years}
                    monthOptions={monthOptions}
                    idPrefix="mensal"
                  />
                  <div className="text-sm opacity-70" style={{marginTop:12}}>
                    Gera: Pizza do m√™s + Resumo por pessoa + Balan√ßo divididas + Listagem com links.
                  </div>
                </div>
                <div className="footer flex gap-2 justify-end">
                  <button className="btn ghost" onClick={()=>onChangeTab('home')}>Voltar</button>
                  <button className="btn primary">Gerar PDF</button>
                </div>
              </>
            )}


            {/* PER√çODO */}
            {tab==='periodo' && (
              <>
                <div className="content">
                  <MonthPickerBlock
                    title="Selecione in√≠cio"
                    year={pStartYear} setYear={setPStartYear}
                    month={pStartMonth} setMonth={setPStartMonth}
                    years={years}
                    monthOptions={monthOptions}
                    idPrefix="periodo-inicio"
                  />
                  <MonthPickerBlock
                    title="Selecione final"
                    year={pEndYear} setYear={setPEndYear}
                    month={pEndMonth} setMonth={setPEndMonth}
                    years={years}
                    monthOptions={monthOptions}
                    idPrefix="periodo-fim"
                  />
                  <div className="text-sm opacity-70" style={{marginTop:12}}>
                    Consolidado do per√≠odo.
                  </div>
                </div>
                <div className="footer flex gap-2 justify-end">
                  <button className="btn ghost" onClick={()=>onChangeTab('home')}>Voltar</button>
                  <button className="btn primary">Gerar PDF</button>
                </div>
              </>
            )}


            {/* COMPARATIVOS */}
            {tab==='comparativos' && (
              <>
                <div className="content">
                  {/* Alcance sozinho */}
                  <div className="subpick">
                    <h3>Alcance</h3>
                    <div className="row">
                      <div className="cell" style={{gridColumn:'1 / -1'}}>
                        <label className="text-sm opacity-70" htmlFor="cmp-range">Tipo</label>
                        <select id="cmp-range" className="select"
                                value={cmpRange} onChange={e=>setCmpRange(e.target.value)}>
                          <option value="mes">M√™s √∫nico</option>
                          <option value="periodo">Per√≠odo</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  {cmpRange==='mes' ? (
                    <MonthPickerBlock
                      title="Selecione o m√™s"
                      year={cmpYear} setYear={setCmpYear}
                      month={cmpMonth} setMonth={setCmpMonth}
                      years={years}
                      monthOptions={monthOptions}
                      idPrefix="cmp-mes"
                    />
                  ) : (
                    <>
                      <MonthPickerBlock
                        title="Selecione in√≠cio"
                        year={cmpStartYear} setYear={setCmpStartYear}
                        month={cmpStartMonth} setMonth={setCmpStartMonth}
                        years={years}
                        monthOptions={monthOptions}
                        idPrefix="cmp-inicio"
                      />
                      <MonthPickerBlock
                        title="Selecione final"
                        year={cmpEndYear} setYear={setCmpEndYear}
                        month={cmpEndMonth} setMonth={setCmpEndMonth}
                        years={years}
                        monthOptions={monthOptions}
                        idPrefix="cmp-fim"
                      />
                    </>
                  )}

                  {/* Tipo de gr√°fico */}
                  <div className="subpick">
                    <h3>Tipo de gr√°fico</h3>
                    <div className="row">
                      <div className="cell" style={{gridColumn:'1 / -1'}}>
                        <select className="select" value={cmpType} onChange={e=>setCmpType(e.target.value)}>
                          {cmpRange==='mes' && (<>
                            <option value="pizza">Pizza</option>
                            <option value="barras">Barras</option>
                          </>)}
                          {cmpRange==='periodo' && (<>
                            <option value="pizza">Pizza</option>
                            <option value="linhas">Linhas</option>
                          </>)}
                        </select>

                      </div>
                    </div>
                  </div>

                  <div className="subpick">
                    <h3>Contas (sele√ß√£o m√∫ltipla)</h3>

                    {/* A√ß√µes r√°pidas */}
                    <div className="flex flex-wrap gap-2 mb-2">
                      <button
                        type="button"
                        className="btn ghost"
                        onClick={()=> setCmpSel(new Set(cmpContas))}
                        disabled={cmpContas.length===0}
                        title="Selecionar todas"
                      >
                        Selecionar todas
                      </button>
                      <button
                        type="button"
                        className="btn ghost"
                        onClick={()=> setCmpSel(new Set())}
                        disabled={cmpSel.size===0}
                        title="Limpar sele√ß√£o"
                      >
                        Limpar sele√ß√£o
                      </button>
                    </div>

                    {/* Lista din√¢mica */}
                    {cmpContas.length===0 ? (
                      <div className="text-sm opacity-70">Nenhuma conta encontrada no alcance selecionado.</div>
                    ) : (
                      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
                        {cmpContas.map(name => (
                          <label
                            key={name}
                            className="card flex items-start gap-3 account-chip"
                            title={name}
                          >
                            <input
                              type="checkbox"
                              checked={cmpSel.has(name)}
                              onChange={()=>toggleConta(name)}
                              style={{ marginTop: 3 }}
                            />
                            <span className="account-chip__text">{name}</span>
                          </label>
                        ))}
                      </div>
                    )}
                  </div>


                  <div className="text-sm opacity-70" style={{marginTop:12}}>
                    (Opcional) visualizar gr√°fico antes do download.
                  </div>
                </div>

                <div className="footer flex flex-wrap gap-2 justify-end">
                  {/* Voltar */}
                  <button
                    type="button"
                    className="btn ghost"
                    onClick={()=>onChangeTab('home')}
                  >
                    Voltar
                  </button>

                  {/* Gerar gr√°fico ‚Äî reaproveite SEU handler atual */}
                  <button
                    type="button"
                    className="btn ghost"
                    disabled={cmpSel.size===0 || (cmpRange==='periodo' && cmpType==='barras')}
                    onClick={async (e) => {
                      // limpa √°rea anterior
                      const content = e.currentTarget.closest('.modal').querySelector('.content');
                      content.querySelectorAll('#cmp-chart, .cmp-note').forEach(n => n.remove());

                      // prepara host/canvas helpers
                      const host = document.createElement('div');
                      host.id = 'cmp-chart';
                      host.style.marginTop = '16px';
                      content.appendChild(host);

                      const addNote = (txt) => {
                        const n = document.createElement('div');
                        n.className = 'cmp-note text-sm opacity-70 mt-2';
                        n.textContent = txt;
                        content.appendChild(n);
                      };
                      const addCanvas = (h = '380px') => {
                        const wrap = document.createElement('div');
                        wrap.style.width = '100%';
                        wrap.style.height = h;
                        wrap.style.marginTop = '12px';
                        const c = document.createElement('canvas');
                        wrap.appendChild(c);
                        host.appendChild(wrap);
                        return c;
                      };

                      // utilidades de dados
                      const contasSel = Array.from(cmpSel);
                      const fetchMes = (y, m) => window.DataAdapter.fetchMes(y, m);
                      const monthLabel = (y, m) => `${monthNamePT(m)} / ${y}`;
                      const sumByConta = (items, contas) =>
                        contas.map(c => (items || [])
                          .filter(x => x.nome === c)
                          .reduce((a, b) => a + parseFloat(String(b.valor).replace(/[^\d,]/g,'').replace(/\.(?=\d)/g,'').replace(',','.')) || 0, 0)
                        );
                      const makeMonthsList = (y1, m1, y2, m2) => {
                        const out = []; let y=y1, m=m1;
                        while (y < y2 || (y === y2 && m <= m2)) { out.push({y,m}); m++; if (m>12){m=1;y++;} }
                        return out;
                      };

                      // aplica defaults do Chart.js
                      if (window.ChartFeatures?.setupChartDefaults) window.ChartFeatures.setupChartDefaults();

                      // --- PIZZA ---
                      if (cmpType === 'pizza') {
                        if (cmpRange === 'mes') {
                          const cur = await fetchMes(cmpYear, cmpMonth);
                          const valores = sumByConta(cur, contasSel);
                          const c = addCanvas();
                          window.ChartFeatures.renderPizzaMensal(c, { labels: contasSel, valores }, monthLabel(cmpYear, cmpMonth));
                          return;
                        } else {
                          const months = makeMonthsList(cmpStartYear, cmpStartMonth, cmpEndYear, cmpEndMonth);
                          // üî• performance: busca em paralelo
                          const respostas = await Promise.all(months.map(({y,m}) => fetchMes(y,m)));
                          const soma = new Array(contasSel.length).fill(0);
                          respostas.forEach(items => {
                            const v = sumByConta(items, contasSel);
                            v.forEach((n, i) => soma[i] += n);
                          });
                          const c = addCanvas();
                          const rot = `${monthNamePT(cmpStartMonth)} ${cmpStartYear} ‚Äì ${monthNamePT(cmpEndMonth)} ${cmpEndYear}`;
                          window.ChartFeatures.renderPizzaMensal(c, { labels: contasSel, valores: soma }, rot);
                          return;
                        }
                      }

                      // --- LINHAS (per√≠odo) ---
                      if (cmpType === 'linhas' && cmpRange === 'periodo') {
                        const months = makeMonthsList(cmpStartYear, cmpStartMonth, cmpEndYear, cmpEndMonth);
                        const labelsMes = months.map(({y,m}) => `${monthNamePT(m).slice(0,3)}/${y}`);
                        const respostas = await Promise.all(months.map(({y,m}) => fetchMes(y,m)));

                        let plotted = 0;
                        contasSel.forEach((conta) => {
                          const serie = respostas.map(items =>
                            (items || []).filter(x => x.nome === conta)
                              .reduce((a,b) => a + parseFloat(String(b.valor).replace(/[^\d,]/g,'').replace(/\.(?=\d)/g,'').replace(',','.')) || 0, 0)
                          );
                          const pontos = serie.filter(v => v > 0).length;
                          if (pontos >= 2) {
                            const c = addCanvas();
                            window.ChartFeatures.renderLinhaContaPeriodo(c, { nome: conta, meses: labelsMes, valores: serie });
                            plotted++;
                          } else {
                            addNote(`‚ö†Ô∏è "${conta}": sem reincid√™ncia suficiente no per√≠odo para linhas.`);
                          }
                        });

                        if (plotted === 0) addNote('Nenhuma conta possui dados em 2 ou mais meses no per√≠odo selecionado.');
                        return;
                      }

                      // --- BARRAS (m√™s √∫nico; 2 compara√ß√µes lado a lado) ---
                      if (cmpType === 'barras' && cmpRange === 'mes') {
                        const atual = await fetchMes(cmpYear, cmpMonth);
                        const valsAtual = sumByConta(atual, contasSel);
                        const rotAtual = monthLabel(cmpYear, cmpMonth);

                        // m√™s anterior
                        const prevM = cmpMonth > 1 ? cmpMonth - 1 : 12;
                        const prevY = cmpMonth > 1 ? cmpYear : (cmpYear - 1);
                        const ant = await fetchMes(prevY, prevM);
                        const valsAnt = sumByConta(ant, contasSel);
                        const temAnt = valsAnt.some(v => v > 0);

                        // mesmo m√™s do ano anterior
                        const anoAnt = await fetchMes(cmpYear - 1, cmpMonth);
                        const valsAnoAnt = sumByConta(anoAnt, contasSel);
                        const temAnoAnt = valsAnoAnt.some(v => v > 0);

                        if (temAnt) {
                          const c1 = addCanvas('360px');
                          window.ChartFeatures.renderBarrasComparativas(
                            c1,
                            { labels: contasSel, atual: valsAtual, comparado: valsAnt },
                            'anterior',
                            { atual: rotAtual, comparado: monthLabel(prevY, prevM) }
                          );
                        } else {
                          addNote('‚ÑπÔ∏è Sem conta correspondente no m√™s anterior para as sele√ß√µes atuais.');
                        }

                        if (temAnoAnt) {
                          const c2 = addCanvas('360px');
                          window.ChartFeatures.renderBarrasComparativas(
                            c2,
                            { labels: contasSel, atual: valsAtual, comparado: valsAnoAnt },
                            'anoAnterior',
                            { atual: rotAtual, comparado: monthLabel(cmpYear - 1, cmpMonth) }
                          );
                        } else {
                          addNote('‚ÑπÔ∏è Sem conta correspondente no mesmo m√™s do ano anterior para as sele√ß√µes atuais.');
                        }

                        if (!temAnt && !temAnoAnt) addNote('Nenhuma base compar√°vel encontrada.');
                        return;
                      }

                      // combina√ß√£o inv√°lida (ex.: barras + per√≠odo)
                      alert('Combina√ß√£o de alcance e tipo n√£o suportada.');
                    }
}
                  >
                    Gerar gr√°fico
                  </button>

                  {/* Baixar PNG (primeiro gr√°fico) */}
                  <button
                    type="button"
                    className="btn primary"
                    disabled={cmpSel.size===0}
                    onClick={()=>{
                      const firstCanvas = document.querySelector('#cmp-chart canvas');
                      if (!firstCanvas) return alert('Gere um gr√°fico antes!');
                      const a = document.createElement('a');
                      a.download = 'grafico.png';
                      a.href = firstCanvas.toDataURL('image/png');
                      a.click();
                    }}
                  >
                    Baixar PNG
                  </button>

                  {/* Baixar PDF (todos os gr√°ficos renderizados) */}
                  <button
                    type="button"
                    className="btn primary"
                    disabled={cmpSel.size===0}
                    onClick={()=>{
                      const wrapper = document.getElementById('cmp-chart');
                      if (!wrapper) return alert('Gere um ou mais gr√°ficos antes!');
                      const canvases = Array.from(wrapper.querySelectorAll('canvas'));
                      if (canvases.length === 0) return alert('Nenhum gr√°fico encontrado.');

                      window.PDFHelpers.exportTwoPerPage(canvases, 'graficos.pdf', {
                        margin: 28,   // ajuste fino se quiser 24‚Äì36
                        gap: 24       // espa√ßo entre os 2 gr√°ficos (20‚Äì32 tamb√©m fica bom)
                      });


                      
                    }}
                  >
                    Baixar PDF (todos)
                  </button>
                </div>


                {cmpSel.size===0 && (
                  <div className="text-xs opacity-70 mt-2 text-right">
                    Selecione ao menos 1 conta.
                  </div>
                )}


              </>
            )}

          </div>
        </div>
      );
    }

    // ====== Mount App ======
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    const rootEl = document.getElementById('root');
    

  function getThemeClass() {
    const themed = rootEl.querySelector('.theme-gunmetal, .theme-synth, .theme-light');
    if (!themed) return null;
    return Array.from(themed.classList).find(c => /^theme-(gunmetal|synth|light)$/.test(c));
  }

  function syncTheme() {
    const cls = getThemeClass();
    document.body.classList.remove('theme-gunmetal','theme-synth','theme-light');
    if (cls) document.body.classList.add(cls);
  }
  
  // sincroniza agora e toda vez que mudar algo no subtree
  syncTheme();
  new MutationObserver(syncTheme).observe(rootEl, { attributes:true, childList:true, subtree:true });
  </script>
    <!-- === Gr√°ficos === -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-piechart-outlabels@1.1.0"></script>

  <script type="module" src="./src/features/charts.js"></script>

  <!-- jsPDF para exportar m√∫ltiplos gr√°ficos em PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- PDF features -->
  <script src="./src/features/pdf.js"></script>



  <script type="module" src="./src/router.js"></script>
  <!-- novo: boot do router como m√≥dulo -->
  <script type="module" src="./src/data-adapter.js"></script>

  <script type="module">
    import { Router } from './src/router.js';
    window.Router = Router; // üëà torna global p/ o JSX

    Router.register('#/', () => {
      // rota default: cai na tela do m√™s atual (sem mudar estado)
      Router.go('#/mes');
    });

    Router.register('#/mes', (params) => {
      // aplica ano/mes na UI se vierem na URL
      window.AppRoutes?.mes(params);
    });

    Router.register('#/relatorios', () => {
      window.AppRoutes?.relatorios();
    });

    Router.start();
  </script>

</body>
</html>
